<?php

define('AVAILABLE_PUBLIC', 3);
define('DEFAULT_DOC_CACHE_PATH', 'public://pws_documents/');

function os2web_pws_admin_paths() {
  return array(
      'admin/config/os2web' => TRUE,
      'admin/config/os2web/pws' => TRUE,
  );
}

function os2web_pws_menu() {
  $items['admin/config/os2web/pws'] = array(
      'title' => 'PWS Setup',
      'description' => t('Set up endpoints for PWS webservices.'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('os2web_pws_config_form'),
      'access arguments' => array('administer os2web'),
      'file' => 'os2web_pws.admin.inc',
      'type' => MENU_NORMAL_ITEM | MENU_LOCAL_TASK,
  );
  $items['os2web/test/pws'] = array(
      'title' => 'PWS Test',
      'page callback' => 'os2web_test_page',
      'access arguments' => array('administer os2web'),
      'type' => MENU_CALLBACK,
  );
  $items['os2web/showcase/%'] = array(
      'title callback' => 'os2web_pws_case_listing_title',
      'title arguments' => array(2),
      'page callback' => 'os2web_pws_case_listing',
      'page arguments' => array(2),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
  );
  $items['os2web/showcase/%/%'] = array(
      'title callback' => 'os2web_pws_case_listing_title',
      'title arguments' => array(2, 3),
      'page callback' => 'os2web_pws_case_listing',
      'page arguments' => array(2, 3),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
  );
  return $items;
}

function os2web_pws_theme() {
  return array(
      'esdh_document' => array(
          'variables' => array('id' => FALSE),
      ),
      'esdh_case' => array(
          'variables' => array('id' => FALSE),
      ),
  );
}

/**
 * Factory for class instances. This allows easy changing between api classes.
 * TODO: Make this proper plugin-able.
 *
 * @return AcadrePWS object
 */
function _os2web_pws_get_instance() {
  module_load_include('inc', 'os2web_pws', 'AcadrePWS.class');
  return new AcadrePWS();
  module_load_include('inc', 'os2web_pws', 'AcadrePWSMock.class');
  return new AcadrePWSMock();
}

function os2web_pws_case_listing_title($id, $id2 = false) {
  $case = &drupal_static('os2web_pws_case', FALSE);
  if (FALSE === $case) {
    $pws = _os2web_pws_get_instance();
    if (FALSE != $id2) {
      $id = $pws->lookupCase($id . "/" . $id2);
    }
    $case = $pws->fetchCase($id);
  }
  if (FALSE != $case) {
    return t('Show case: @caseid - @titletext', array('@caseid' => $case->CaseFileNumberIdentifier, '@titletext' => $case->CaseFileTitleText));
  } else {
    return t('Case not found');
  }
}

function os2web_pws_case_listing($id, $id2 = false) {
  $pws = _os2web_pws_get_instance();
  error_log(basename(__FILE__) . ':' . __LINE__ . ' Var: $id = ' . print_r($id, 1));
  error_log(basename(__FILE__) . ':' . __LINE__ . ' Var: $id2 = ' . print_r($id2, 1));
  if (FALSE != $id2) {
    $id = $pws->lookupCase($id . "/" . $id2);
  }
  $output = theme('esdh_case', array('id' => $id));
  if (FALSE != $output) {
    return $output;
  } else {
    drupal_not_found();
  }
}

function theme_esdh_case($vars) {
  $id = $vars['id'];

  $pws = _os2web_pws_get_instance();
  $case = $pws->fetchCase($id);
  if (FALSE === $case) {
    return FALSE;
  }
  $docs = $pws->getCaseDocs($id);
  $header = array(t('Id'), t('Title'), t('Contents'), t('Date'));
  $rows = array();
  $rows[] = array($case->CaseFileNumberIdentifier,$case->CaseFileTitleText, $case->CustomFields->df1, format_date(strtotime($case->CreationDate), 'custom', 'd-m-Y'));
  $html = theme('table', array('header' => $header, 'rows' => $rows));
  $docids = array();
  foreach ($docs as $doc) {
    $docids[] = (int) $doc->Document->DocumentIdentifier;
  }
  $html .= '<p>' . t('This case contains @docs public documents', array('@docs' => count($rows))) . '</p>';
  $html .= theme('esdh_document', array('id' => $docids));
  return $html;
}

function theme_esdh_document($vars) {
  $id = $vars['id'];

  $pws = _os2web_pws_get_instance();
  if (!is_array($id)) {
    $id = array($id);
  }
  $html = '';
  $rows = array();
  $header = array(t('Title'), t('Description'), t('Date'));

  foreach ($id as $docid) {
    $doc = $pws->getDocument($docid);
    error_log(basename(__FILE__) . ':' . __LINE__ . ' Var: $doc = ' . print_r($doc, 1));
    if (FALSE != $doc && $doc->Record->PublicationIndicator == AVAILABLE_PUBLIC) { // Only show public documents
      //FIXME: Check publication status
      $rows[] = array(
          l($doc->Document->DocumentTitleText, $pws->getDocData($doc->Document->DocumentIdentifier)),
          $doc->Record->DescriptionText,
          $doc->Record->DocumentDate,
      );
    }
  }
  if (count($rows) == 0) {
    return false;
  }
  $html .= theme('table', array('header' => $header, 'rows' => $rows));
  return $html;
}

function os2web_test_page() {
  error_log('MARK - ' . basename(__FILE__) . ':' . __LINE__ . ' in ' . __FUNCTION__ . '()');
  $pws = _os2web_pws_get_instance();
//  $cid = $pws->lookupCase('11/14293');
  $call = $pws->fetchCase(373830);
//  $call = $pws->getCaseDocs(373830);
//  $call = $pws->fetchCase(340222);
//  return _os2web_get_rendered_doc(array(1420175,1369822));
//  $call = $pws->getDocument(1565429);
//  $call = $pws->getDocument(373830);
//
//  $call = $pws->getDocFileName(3023484,1);
//  $call = $pws->getDocFileName(1565429);
//  $call = $pws->getDocFileName(3258320,1);
//  $call = $pws->getDocData(3258320, 1);
//  $call = $pws->getDocData(1565429);
//
//  $call = $call->ArrayOfDocuments->DocumentOutput;
//  $call = $pws->searchCases('12/2252');
//  error_log(var_export($call,1));
//  foreach ($call as $item) {
//    error_log(basename(__FILE__) . ':' . __LINE__ . ' Var: $item = ' . print_r($item, 1));
//  }
//  return 'test';
  return '<div><textarea cols="150" rows=50>' . print_r($call, 1) . '</textarea></div>';
}
